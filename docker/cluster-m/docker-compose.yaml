# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

services:
  spark-master:
    image: docker.io/bitnami/spark:3.5.3
    environment:
      - SPARK_MODE=master
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    hostname: spark-master
    ports:
      - '8080:8080'
      - '7077:7077'
    volumes:
      - ../../data/:/mnt/data/
      - ../../results/:/mnt/results/
      - ../../benchmark/target/scala-2.12/:/mnt/jar/
      - ../../temporary:/mnt/temporary/

  spark-driver:
    image: docker.io/bitnami/spark:3.5.3
    environment:
      - INTERWALLED_CSV_DIRECTORY=/mnt/results/default.csv
      - INTERWALLED_DATA_DIRECTORY=/mnt/data
      - SPARK_MODE=driver
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    hostname: spark-driver
    ports:
      - '4040:4040'
    command:
      - "/opt/bitnami/spark/bin/spark-submit"
      - "--master"
      - "spark://spark-master:7077"
      - "--deploy-mode"
      - "client"
      - "--driver-memory"
      - "4G"
      - "--executor-memory"
      - "4G"
      - "--executor-cores"
      - "4"
      - "--class"
      - "me.kosik.interwalled.benchmark.Main"
      - "/mnt/jar/interwalled-benchmark.jar"
      - "$IW_APP_COMMAND"
      - "$IW_DATA"
      - "$IW_BENCHMARK"

    volumes:
      - ../../data/:/mnt/data/
      - ../../results/:/mnt/results/
      - ../../docker/scripts/:/mnt/scripts/
      - ../../benchmark/target/scala-2.12/:/mnt/jar/
      - ../../temporary:/mnt/temporary/

    deploy:
      resources:
        limits:
          memory: 4G

  spark-worker:
    image: docker.io/bitnami/spark:3.5.3
    deploy:
      replicas: 5
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - SPARK_WORKER_MEMORY=4G
      - SPARK_WORKER_CORES=4
      - SPARK_RPC_AUTHENTICATION_ENABLED=no
      - SPARK_RPC_ENCRYPTION_ENABLED=no
      - SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED=no
      - SPARK_SSL_ENABLED=no
      - SPARK_USER=spark
    ports:
      - '8081'
    volumes:
      - ../../data/:/mnt/data/
      - ../../results/:/mnt/results/
      - ../../benchmark/target/scala-2.12/:/mnt/jar/
      - ../../temporary:/mnt/temporary/